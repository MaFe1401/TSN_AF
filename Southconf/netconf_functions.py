from netconf_client.connect import connect_ssh
from netconf_client.ncclient import Manager
from lxml import etree
import xml.etree.ElementTree as ET


#Gets running configuration from Netopeer server microservice
def getconfig(): 
    session = connect_ssh(host="netopeer", port=830, username="netconf", password="netconf")
    mgr = Manager(session, timeout=120)
    config = mgr.get_config("running").data_xml
    return config.decode('utf-8')

#Filters obtained configuration (deletes keystore xml fragment)
def filterInterfaces(config):
    xml = etree.XML(config)
    #interfaces = xml.xpath("//interfaces")
    interfaces = xml.find(".//",namespaces=None)
    # Iterating through child tags
    '''
    for elem in interfaces.iter():
        tag_elements = elem.tag.split("}")
        
        # Removing name spaces and attributes
        elem.tag = tag_elements[1]
        elem.attrib.clear()

        updated_data = ET.tostring(interfaces, encoding="unicode")

    print(updated_data)
    '''
    #xml.remove(keystore)
    #xml.strip_elements(xml,"urn:ietf:params:xml:ns:yang:ietf-keystore")
    #print(ET.tostring(interfaces,encoding="unicode"))
    return etree.tostring(interfaces,encoding="unicode")
#Edits configuration of TSN NICs placed at the edges of the 5G logical TSN bridge
def editconfig(ip, payload):
    session = connect_ssh(host=ip, port=830, username="sys-admin", password="sys-admin")
    mgr = Manager(session, timeout=120)
    mgr.edit_config(config=str(payload))

config = """<data xmlns="urn:ietf:params:xml:ns:netconf:base:1.0"><interfaces xmlns="urn:ietf:params:xml:ns:yang:ietf-interfaces"><interface><name>PORT_0</name><type xmlns:ianaift="urn:ietf:params:xml:ns:yang:iana-if-type">ianaift:ethernetCsmacd</type><bridge-port xmlns="urn:ieee:std:802.1Q:yang:ieee802-dot1q-bridge"><gate-parameter-table xmlns="urn:ieee:std:802.1Q:yang:ieee802-dot1q-sched"><gate-enabled>true</gate-enabled><admin-gate-states>255</admin-gate-states><admin-control-list><gate-control-entry><index>0</index><operation-name xmlns:sched="urn:ieee:std:802.1Q:yang:ieee802-dot1q-sched">sched:set-gate-states</operation-name><time-interval-value>12000</time-interval-value><gate-states-value>4</gate-states-value></gate-control-entry><gate-control-entry><index>1</index><operation-name xmlns:sched="urn:ieee:std:802.1Q:yang:ieee802-dot1q-sched">sched:set-gate-states</operation-name><time-interval-value>12000</time-interval-value><gate-states-value>255</gate-states-value></gate-control-entry><gate-control-entry><index>2</index><operation-name xmlns:sched="urn:ieee:std:802.1Q:yang:ieee802-dot1q-sched">sched:set-gate-states</operation-name><time-interval-value>12000</time-interval-value><gate-states-value>2</gate-states-value></gate-control-entry><gate-control-entry><index>3</index><operation-name xmlns:sched="urn:ieee:std:802.1Q:yang:ieee802-dot1q-sched">sched:set-gate-states</operation-name><time-interval-value>4964000</time-interval-value><gate-states-value>255</gate-states-value></gate-control-entry><gate-control-entry><index>4</index><operation-name xmlns:sched="urn:ieee:std:802.1Q:yang:ieee802-dot1q-sched">sched:set-gate-states</operation-name><time-interval-value>12000</time-interval-value><gate-states-value>4</gate-states-value></gate-control-entry><gate-control-entry><index>5</index><operation-name xmlns:sched="urn:ieee:std:802.1Q:yang:ieee802-dot1q-sched">sched:set-gate-states</operation-name><time-interval-value>12000</time-interval-value><gate-states-value>255</gate-states-value></gate-control-entry><gate-control-entry><index>6</index><operation-name xmlns:sched="urn:ieee:std:802.1Q:yang:ieee802-dot1q-sched">sched:set-gate-states</operation-name><time-interval-value>12000</time-interval-value><gate-states-value>255</gate-states-value></gate-control-entry><gate-control-entry><index>7</index><operation-name xmlns:sched="urn:ieee:std:802.1Q:yang:ieee802-dot1q-sched">sched:set-gate-states</operation-name><time-interval-value>1000</time-interval-value><gate-states-value>255</gate-states-value></gate-control-entry></admin-control-list><admin-cycle-time><numerator>1000000</numerator><denominator>1000000000</denominator></admin-cycle-time><admin-cycle-time-extension>0</admin-cycle-time-extension><admin-base-time><seconds>0</seconds><nanoseconds>0</nanoseconds></admin-base-time><config-change>true</config-change><supported-list-max>90</supported-list-max><supported-cycle-max><numerator>99999999</numerator><denominator>999999999</denominator></supported-cycle-max><supported-interval-max>999999999</supported-interval-max></gate-parameter-table></bridge-port></interface><interface><name>PORT_1</name><type xmlns:ianaift="urn:ietf:params:xml:ns:yang:iana-if-type">ianaift:ethernetCsmacd</type><bridge-port xmlns="urn:ieee:std:802.1Q:yang:ieee802-dot1q-bridge"><gate-parameter-table xmlns="urn:ieee:std:802.1Q:yang:ieee802-dot1q-sched"><gate-enabled>true</gate-enabled><admin-gate-states>255</admin-gate-states><admin-control-list><gate-control-entry><index>0</index><operation-name xmlns:sched="urn:ieee:std:802.1Q:yang:ieee802-dot1q-sched">sched:set-gate-states</operation-name><time-interval-value>12000</time-interval-value><gate-states-value>4</gate-states-value></gate-control-entry><gate-control-entry><index>1</index><operation-name xmlns:sched="urn:ieee:std:802.1Q:yang:ieee802-dot1q-sched">sched:set-gate-states</operation-name><time-interval-value>4963000</time-interval-value><gate-states-value>255</gate-states-value></gate-control-entry><gate-control-entry><index>2</index><operation-name xmlns:sched="urn:ieee:std:802.1Q:yang:ieee802-dot1q-sched">sched:set-gate-states</operation-name><time-interval-value>12000</time-interval-value><gate-states-value>2</gate-states-value></gate-control-entry><gate-control-entry><index>3</index><operation-name xmlns:sched="urn:ieee:std:802.1Q:yang:ieee802-dot1q-sched">sched:set-gate-states</operation-name><time-interval-value>13000</time-interval-value><gate-states-value>255</gate-states-value></gate-control-entry><gate-control-entry><index>4</index><operation-name xmlns:sched="urn:ieee:std:802.1Q:yang:ieee802-dot1q-sched">sched:set-gate-states</operation-name><time-interval-value>12000</time-interval-value><gate-states-value>4</gate-states-value></gate-control-entry><gate-control-entry><index>5</index><operation-name xmlns:sched="urn:ieee:std:802.1Q:yang:ieee802-dot1q-sched">sched:set-gate-states</operation-name><time-interval-value>4951000</time-interval-value><gate-states-value>255</gate-states-value></gate-control-entry><gate-control-entry><index>6</index><operation-name xmlns:sched="urn:ieee:std:802.1Q:yang:ieee802-dot1q-sched">sched:set-gate-states</operation-name><time-interval-value>12000</time-interval-value><gate-states-value>1</gate-states-value></gate-control-entry><gate-control-entry><index>7</index><operation-name xmlns:sched="urn:ieee:std:802.1Q:yang:ieee802-dot1q-sched">sched:set-gate-states</operation-name><time-interval-value>12000</time-interval-value><gate-states-value>255</gate-states-value></gate-control-entry><gate-control-entry><index>8</index><operation-name xmlns:sched="urn:ieee:std:802.1Q:yang:ieee802-dot1q-sched">sched:set-gate-states</operation-name><time-interval-value>13000</time-interval-value><gate-states-value>255</gate-states-value></gate-control-entry></admin-control-list><admin-cycle-time><numerator>1000000</numerator><denominator>1000000000</denominator></admin-cycle-time><admin-cycle-time-extension>0</admin-cycle-time-extension><admin-base-time><seconds>0</seconds><nanoseconds>0</nanoseconds></admin-base-time><config-change>true</config-change><supported-list-max>90</supported-list-max><supported-cycle-max><numerator>99999999</numerator><denominator>999999999</denominator></supported-cycle-max><supported-interval-max>999999999</supported-interval-max></gate-parameter-table></bridge-port></interface></interfaces><keystore xmlns="urn:ietf:params:xml:ns:yang:ietf-keystore"><asymmetric-keys><asymmetric-key><name>genkey</name><algorithm>rsa2048</algorithm><public-key>MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAsKs9JB7+4mXV0qmEmmE8r3bU2sifGKrtwYai1kLqbFEVp5EicfF1LFLcEjr04hIjTwi/FDkGmli9zizsiqpXQj/bmX0k3f+Oztu7Ozk5tdGyrC095k5Ntfm8y7JT4Fp7caxU2Sc6RtByI1H9FjWGcCBNx2PG2QGHXQ4t/JEttKEawY3VmwtF1MZsglQ4fKLnHoDi4R49dsPWuYgUhCqLMdE+t5miFa/DNCFOx52kNbKffzgSZsoCOa/hBVoe2qNu/Vvb/6R+ZjEh2Z2CBbYVqc6TtCTKJLElyJLTQRZHwFY2a//jbzY+7avF3epSCx61gXXqmN5I0x+wYjKDYy2tDQIDAQAB</public-key></asymmetric-key></asymmetric-keys></keystore><netconf-server xmlns="urn:ietf:params:xml:ns:yang:ietf-netconf-server"><listen><endpoint><name>default-ssh</name><ssh><tcp-server-parameters><local-address>0.0.0.0</local-address><keepalives><idle-time>1</idle-time><max-probes>10</max-probes><probe-interval>5</probe-interval></keepalives></tcp-server-parameters><ssh-server-parameters><server-identity><host-key><name>default-key</name><public-key><keystore-reference>genkey</keystore-reference></public-key></host-key></server-identity><client-authentication><supported-authentication-methods><publickey/><passsword/></supported-authentication-methods></client-authentication></ssh-server-parameters></ssh></endpoint></listen></netconf-server></data>"""
filterconfig(config)